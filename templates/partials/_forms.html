{% include 'partials/_messages.html' %}
{% if form %}
  <form method="post" class="needs-validation" novalidate id="main-form">
    {% csrf_token %}
    {% if form.city %}
      <div class="mb-3" id="field-city">
        {{ form.city.label_tag }}
        {{ form.city }}
        {% if form.city.help_text %}<div class="form-text">{{ form.city.help_text }}</div>{% endif %}
        {% if form.city.errors %}<div class="text-danger small">{{ form.city.errors|striptags }}</div>{% endif %}
      </div>
    {% endif %}
    {% if form.district %}
      <div class="mb-3" id="field-district" style="display: none;">
        {{ form.district.label_tag }}
        {{ form.district }}
        {% if form.district.help_text %}<div class="form-text">{{ form.district.help_text }}</div>{% endif %}
        {% if form.district.errors %}<div class="text-danger small">{{ form.district.errors|striptags }}</div>{% endif %}
      </div>
    {% endif %}
    {% if form.city_other %}
      <div class="mb-3" id="field-city_other" style="display: none;">
        {{ form.city_other.label_tag }}
        {{ form.city_other }}
        {% if form.city_other.help_text %}<div class="form-text">{{ form.city_other.help_text }}</div>{% endif %}
        {% if form.city_other.errors %}<div class="text-danger small">{{ form.city_other.errors|striptags }}</div>{% endif %}
      </div>
    {% endif %}
    {% if form.district_other %}
      <div class="mb-3" id="field-district_other" style="display: none;">
        {{ form.district_other.label_tag }}
        {{ form.district_other }}
        {% if form.district_other.help_text %}<div class="form-text">{{ form.district_other.help_text }}</div>{% endif %}
        {% if form.district_other.errors %}<div class="text-danger small">{{ form.district_other.errors|striptags }}</div>{% endif %}
      </div>
    {% endif %}
    {% for field in form %}
      {% if field.name != 'city' and field.name != 'district' and field.name != 'city_other' and field.name != 'district_other' %}
        <div class="mb-3" id="field-{{ field.name }}">
          {{ field.label_tag }}
          {% if field.name == 'brand' %}
            <div style="display: flex; gap: 4px; align-items: stretch;">
              <div style="flex: 1; min-width: 0;">{{ field }}</div>
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addBrandModal" title="Yeni Marka Ekle">+</button>
            </div>
          {% elif field.name == 'category' %}
            <div id="category-fields">
              <div class="category-select-row" style="display: flex; gap: 4px; align-items: stretch; margin-bottom: 4px;">
                <div style="flex: 1; min-width: 0;">{{ field }}</div>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Yeni Kategori Ekle">+</button>
              </div>
            </div>
            <small class="text-muted">En fazla 5 kategori seçebilirsiniz.</small>
          {% else %}
            {{ field }}
          {% endif %}
          {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
          {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
        </div>
      {% endif %}
    {% endfor %}
    <button type="submit" class="btn btn-primary">Gönder</button>
  </form>

  <!-- Marka Ekle Modal -->
  <div class="modal fade" id="addBrandModal" tabindex="-1" aria-labelledby="addBrandModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBrandModalLabel">Yeni Marka Ekle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <form id="addBrandForm">
            <div class="mb-3">
              <label for="brandName" class="form-label">Marka Adı</label>
              <input type="text" class="form-control" id="brandName" name="name" required>
            </div>
            <div id="brandAddMsg" class="text-success small"></div>
            <button type="submit" class="btn btn-success">Ekle</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Kategori Ekle Modal -->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">Yeni Kategori Ekle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <form id="addCategoryForm">
            <div class="mb-3">
              <label for="categoryName" class="form-label">Kategori Adı</label>
              <input type="text" class="form-control" id="categoryName" name="name" required>
            </div>
            <div id="categoryAddMsg" class="text-success small"></div>
            <button type="submit" class="btn btn-success">Ekle</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="alert alert-warning">Form bulunamadı.</div>
{% endif %}
